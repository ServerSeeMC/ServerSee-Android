# 项目规则 - ServerSee APK

## 基础要求
- 操作系统: Windows Server 2022
- 终端: PowerShell
- 语言: 简体中文 (无 emoji)
- Maven 路径: `E:\apache-maven-3.9.12-bin\apache-maven-3.9.12\bin` (需设置环境变量)
- JAVA 路径: `E:\jdk21` (JDK 21) 或 `E:\jdk` (JDK 25)
- 插件端目录: `E:\project\serversee`，需要通过mcp工具filemanager编辑工作区文件。

## 功能设计要求
- **首页**: 标题 "ServerSee 客户端"
- **统计信息**: 顶栏显示总数、离线数量和总玩家数。
- **添加服务器**: 右下角 FAB 按钮，弹窗包含：
    - API 端点 (必填)
    - Token (选填)
- **展示方式**: 首页横向显示卡片，包含：
    - 服务器头像 (Avatar)
    - 内存 (Memory)
    - CPU 使用率
    - 实时 TPS
    - 玩家数量
- **详情页**: 点击卡片进入
    - 底部栏：信息查看、白名单管理、指令执行
    - **UI 风格**: 现代化卡片式设计，包含渐变背景、圆角卡片、图标辅助展示，以及性能指标的色彩状态提示（如 TPS 正常显示绿色，过低显示红色）。
    - **权限控制**: 若无 Token，不显示白名单管理和指令执行，也不显示底部栏。

## 知识点记录
- **API 鉴权**: 管理员接口需使用 `Authorization: Bearer <Token>` 请求头。
- **数据刷新**: 首页采用 5 秒轮询机制更新各服务器的 TPS、CPU 和内存状态。
- **权限隔离**: 详情页根据 `token` 是否为空动态切换 UI 布局，隐藏敏感操作入口。
- **主题管理**: 支持系统自适应主题（深色/浅色模式），并集成了 Android 12+ 的动态色彩 (Dynamic Color) 功能。
- **持久化**: 使用 Room 存储服务器配置，确保应用重启后数据不丢失。
- **Gradle 配置**: 必须启用 `android.useAndroidX` 和 `android.enableJetifier` 以支持现代库。
- **Compose 实验性 API**: 使用 `basicMarquee` 或 `CenterAlignedTopAppBar` 等实验性组件时，需添加 `@OptIn` 注解及对应库引用。
- **图标资源**: 已根据 `ai_studio_code.txt` 中的 SVG 设计实现了 Material 3 风格的自适应图标 (Adaptive Icon)。包含背景层 (`#E0F2F1`) 和前景层 (深青色条纹与高亮装饰点)，并适配了 API 26+ 的自适应特性及旧版本的兼容显示。
- **CI/CD**: 已配置 GitHub Actions 工作流。每次推送到 `main`/`master` 分支会自动执行构建，推送以 `v*` 开头的 Tag 时会自动创建 GitHub Release 并上传构建产物（Plugin 的 Shaded JAR 或 APK 文件）。工作流已配置 `contents: write` 权限。
- **资源引用**: `AndroidManifest.xml` 中引用的图标或主题必须在 `res` 目录中真实存在，否则会导致 AAPT 编译错误。目前已配置 `@mipmap/ic_launcher`。
- **明文传输**: Android 9+ 默认禁止 HTTP 明文传输。需在 `res/xml` 创建 `network_security_config.xml` 允许明文传输，并在 `AndroidManifest.xml` 的 `application` 标签中通过 `android:networkSecurityConfig` 引用。
- **403 错误处理**: 若 API 返回 403 Forbidden，通常是由于缺少 `User-Agent` 或服务器配置了强制鉴权。已在 `ServerRepository` 中通过 `OkHttpClient` 拦截器统一添加 `User-Agent`，并确保所有请求（包括状态查询）在有 Token 时都会携带 `Authorization` 头。
- **添加服务器优化**: 在添加服务器弹窗中集成了“获取服务器信息并测试”功能。支持实时预览服务器图标 (Avatar) 和 MOTD（支持颜色解析）。增加“自动使用 MOTD 作为名称”选项，并支持可选的“服务器连接地址”存储，简化添加流程。
- **UI 适配**: 首页和卡片组件已全面适配 Material 3 动态颜色和系统主题（深色/浅色模式），确保在不同主题下均有良好的视觉表现。
- **数据库升级**: 引入了 Room 数据库版本升级机制 (v1 -> v2 -> v3)，并配置了破坏性迁移以支持新字段的添加。
- **系统指标采集**: 后端插件引入了 `oshi-core` 库以采集物理主机的内存和磁盘使用情况。由于 Minecraft 插件环境的特殊性，通过 `maven-shade-plugin` 对 `oshi` 进行重定向 (Relocation) 以避免类加载冲突。注意：**不可对 JNA (com.sun.jna) 进行重定向**，否则会导致 Native 库加载失败。
- **UI 增强**: 详情页引入了 `LinearProgressIndicator` 展示 CPU、内存和磁盘的百分比进度，并支持垂直滚动以适配更多指标。
- **数据精度**: 统一了后端指标的单位（内存 MB，磁盘 GB，CPU 0-100 百分比），并在 Android 端实现了自动单位转换逻辑。注意：Spark API 返回的 CPU 原始值为 0-1 的小数，后端需乘以 100 转换为百分比，以便客户端使用 `%.0f%%` 格式化。
- **服务器图标**: 后端支持读取 `server-icon.png` 并以 Base64 编码形式通过 API 返回，客户端可直接解析并展示服务器图标。同时支持通过“根据服务器地址获取头像”选项，利用第三方服务 (api.mcsrvstat.us) 获取服务器图标。
- **详情页现代化**: 详情页采用 Material 3 规范进行了现代化重构，增加了渐变背景、统计卡片、色彩状态指示器（TPS/MSPT）以及更直观的白名单和终端管理界面。
- **控制台日志同步**: 实现 API 端点通过 WebSocket 实时同步最新日志。支持：
    - 初始连接时加载历史日志（行数通过 `config.yml` 中的 `log-history-lines` 配置，默认 50 行）。
    - 实时推送后续产生的控制台日志。
    - APK 端集成 `MinecraftTextParser` 以支持日志中的颜色代码解析。
    - 终端界面支持自动滚动到最新日志，并限制显示最近 200 条以优化性能。
- **操作审计**: 在后端插件中记录敏感操作审计日志。
    - 当通过 API 执行命令时，记录操作者的 IP 地址和 Token 标识（前 8 位）。
    - 审计日志会直接输出到控制台，并通过 WebSocket 同步到 APK 端。
- **后端优化方案**:
    - **性能**: 引入硬件指标缓存 (10s) 和服务器图标缓存 (10min)，减少高频率 IO 和系统调用。
    - **数据库**: 使用持久连接优化 SQLite 性能，并增加异步任务自动清理 24 小时前的历史数据。
    - **安全**: 实现 IP 级别速率限制 (60 req/min)；WebSocket 鉴权优先支持 Header 模式。
    - **稳定性**: 优化 WebSocket 线程模型，并确保插件关闭时优雅关闭数据库连接。
- **轮询优化**: `ServerViewModel` 引入了动态轮询机制。当用户进入详情页时，将该服务器设为“活跃”状态，轮询频率提升至 3 秒，并额外获取历史指标和原始数据；在首页时，轮询频率为 5 秒，且仅更新基础状态以节省资源。
- **历史趋势展示**: 详情页集成了基于 Compose Canvas 实现的 TPS 历史趋势图表，能够直观展示过去一小时的服务器性能波动。
- **交互体验**: 首页增加了“暂无服务器”的友好提示；卡片样式统一采用 Material 3 风格，增强了视觉层次感。
- **多模式支持**: 实现三种添加方式：
    - **API 端点模式**: 针对安装了 ServerSee 插件的服务器，支持完整指标监控（CPU、内存、TPS 历史、白名单、终端）。
    - **JAVA 地址模式**: 通过 mcsrvstat.us API 获取基础状态，支持普通 JAVA 版服务器。
    - **基岩版地址模式**: 通过 mcsrvstat.us API 获取基础状态，支持基岩版服务器。
- **UI 适配 (多模式)**: 
    - 首页卡片显示模式标识（JAVA/BE）。
    - 详情页根据模式动态显示内容：非 API 模式隐藏性能指标、历史趋势图表、白名单和终端管理，并显示提示信息。
    - 只有 API 模式支持 Token 鉴权和敏感操作。
- **构建体积优化 (JAR)**: 
    - **依赖分析**: 插件体积主要来自 Javalin/Jetty (Web Server)、SQLite-JDBC (包含多平台原生库) 和 OSHI/JNA (系统指标采集)。
    - **优化措施**: 
        - 移除重量级的 Javalin/Jetty 框架，改用轻量级的 `Java-WebSocket` 实现全量通信。
        - 启用 `maven-shade-plugin` 的 `minimizeJar` 选项，剔除未使用的类。
        - 排除不必要的 `META-INF` 资源和 `module-info.class`。
    - **结果**: 优化后构建产物 (Uber JAR) 体积从 ~30MB 降低至约 13.5MB，显著降低了插件分发成本。
- **WebSocket 通信方案**:
    - **架构**: 全面废弃 HTTP RESTful API，采用 WebSocket 承载所有请求与响应。
    - **协议**: 使用自定义 JSON 协议，包含 `id` (请求唯一标识)、`type` (request/response/push)、`action` (操作类型) 和 `token` (鉴权)。
    - **前端实现**: `WebSocketClient` 封装了连接池、请求超时处理、以及基于 `SharedFlow` 的实时推送订阅。
    - **后端实现**: `ApiServer` 继承 `WebSocketServer`，支持并发处理、速率限制和基于 Token 的权限校验。
    - **优势**: 降低了握手开销，支持真正的实时日志推送，并大幅缩小了依赖体积。
